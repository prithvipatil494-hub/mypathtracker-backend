<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Path Tracker Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }

    h1 {
      color: #333;
      margin-bottom: 20px;
      text-align: center;
      font-size: 32px;
    }

    .search-section {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .input-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    input[type="text"] {
      padding: 12px 20px;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-size: 16px;
      width: 250px;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #764ba2;
      box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .sessions-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .session-card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.3s;
      border-left: 4px solid #667eea;
    }

    .session-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(0,0,0,0.3);
    }

    .session-card h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .session-info {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
    }

    .session-info strong {
      color: #333;
    }

    .status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 10px;
    }

    .status.active {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status.stopped {
      background: #f3e5f5;
      color: #6a1b9a;
    }

    .map-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
      margin-bottom: 20px;
      display: none;
    }

    .map-container.active {
      display: block;
    }

    #map {
      width: 100%;
      height: 500px;
    }

    .map-info {
      padding: 20px;
      background: white;
    }

    .loading {
      text-align: center;
      padding: 40px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      border-left: 4px solid #f5576c;
      text-align: center;
    }

    .success {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      border-left: 4px solid #4caf50;
      text-align: center;
    }

    .empty-state {
      background: white;
      padding: 60px 20px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      text-align: center;
      color: #999;
    }

    .empty-state h3 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 20px;
    }

    .close-map {
      background: #f44336;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      float: right;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .stat {
      background: #f7f9fc;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .stat-label {
      font-size: 12px;
      color: #667eea;
      font-weight: 600;
      text-transform: uppercase;
    }

    .stat-value {
      font-size: 24px;
      color: #333;
      font-weight: bold;
      margin-top: 5px;
    }

    @media (max-width: 768px) {
      .search-section {
        flex-direction: column;
      }

      input[type="text"] {
        width: 100%;
      }

      .sessions-container {
        grid-template-columns: 1fr;
      }

      #map {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä Path Tracker Dashboard</h1>
      <div class="search-section">
        <div class="input-group">
          <input type="text" id="userIdInput" placeholder="Enter User ID...">
          <button onclick="loadUserSessions()">üîç Load Sessions</button>
        </div>
      </div>
    </div>

    <div id="content"></div>
  </div>

  <script>
    const BACKEND_URL = 'https://mypathtracker-io.vercel.app';
    let currentSessionId = null;
    let map = null;

    function showMessage(message, type = 'loading') {
      const content = document.getElementById('content');
      
      if (type === 'loading') {
        content.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p>${message}</p>
          </div>
        `;
      } else if (type === 'error') {
        content.innerHTML = `<div class="error">${message}</div>`;
      } else if (type === 'success') {
        content.innerHTML = `<div class="success">${message}</div>`;
      }
    }

    async function fetchFromBackend(endpoint) {
      try {
        const response = await fetch(`${BACKEND_URL}${endpoint}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        console.error('Fetch error:', error);
        throw error;
      }
    }

    async function loadUserSessions() {
      const userId = document.getElementById('userIdInput').value.trim();
      
      if (!userId) {
        showMessage('‚ùå Please enter a User ID', 'error');
        return;
      }

      showMessage('Loading sessions...', 'loading');

      try {
        const data = await fetchFromBackend(`/api/user/${userId}/sessions`);
        
        if (!data.sessions || data.sessions.length === 0) {
          showMessage('üì≠ No sessions found for this user', 'success');
          return;
        }

        displaySessions(data.sessions, userId);
      } catch (error) {
        showMessage(`‚ùå Error loading sessions: ${error.message}`, 'error');
      }
    }

    function displaySessions(sessions, userId) {
      const content = document.getElementById('content');
      
      const sessionCards = sessions.map(session => `
        <div class="session-card" onclick="viewSessionDetails('${session.sessionId}')">
          <h3>üìç Session</h3>
          <div class="session-info">
            <span>Started:</span>
            <strong>${new Date(session.startTime).toLocaleString()}</strong>
          </div>
          <div class="session-info">
            <span>Locations:</span>
            <strong>${session.locationCount || 0}</strong>
          </div>
          <div class="session-info">
            <span>Duration:</span>
            <strong>${session.updateFrequency}s intervals</strong>
          </div>
          ${session.endTime ? `
            <div class="session-info">
              <span>Ended:</span>
              <strong>${new Date(session.endTime).toLocaleString()}</strong>
            </div>
          ` : ''}
          <span class="status ${session.status}">${session.status.toUpperCase()}</span>
        </div>
      `).join('');

      const activeCount = sessions.filter(s => s.status === 'active').length;
      const totalLocations = sessions.reduce((sum, s) => sum + (s.locationCount || 0), 0);

      content.innerHTML = `
        <div class="stats-grid">
          <div class="stat">
            <div class="stat-label">Total Sessions</div>
            <div class="stat-value">${sessions.length}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Active Sessions</div>
            <div class="stat-value">${activeCount}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Total Locations</div>
            <div class="stat-value">${totalLocations}</div>
          </div>
          <div class="stat">
            <div class="stat-label">User ID</div>
            <div class="stat-value">${userId.substring(0, 12)}...</div>
          </div>
        </div>
        <div class="sessions-container">
          ${sessionCards}
        </div>
      `;
    }

    async function viewSessionDetails(sessionId) {
      currentSessionId = sessionId;
      
      const content = document.getElementById('content');
      content.innerHTML = `
        <button onclick="loadUserSessions()" style="margin-bottom: 20px;">‚Üê Back to Sessions</button>
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading session details...</p>
        </div>
      `;

      try {
        const data = await fetchFromBackend(`/api/session/${sessionId}/data`);
        
        displaySessionDetails(data);
      } catch (error) {
        content.innerHTML = `
          <button onclick="loadUserSessions()" style="margin-bottom: 20px;">‚Üê Back to Sessions</button>
          <div class="error">‚ùå Error loading session details: ${error.message}</div>
        `;
      }
    }

    function displaySessionDetails(data) {
      const { session, locations, stats } = data;
      const content = document.getElementById('content');

      let duration = '---';
      if (session.startTime && session.endTime) {
        const start = new Date(session.startTime);
        const end = new Date(session.endTime);
        const diff = Math.floor((end - start) / 1000);
        const hours = Math.floor(diff / 3600);
        const minutes = Math.floor((diff % 3600) / 60);
        const seconds = diff % 60;
        duration = `${hours}h ${minutes}m ${seconds}s`;
      }

      content.innerHTML = `
        <button onclick="loadUserSessions()" style="margin-bottom: 20px;">‚Üê Back to Sessions</button>
        
        <div class="stats-grid">
          <div class="stat">
            <div class="stat-label">Session ID</div>
            <div class="stat-value">${session.sessionId.substring(0, 12)}...</div>
          </div>
          <div class="stat">
            <div class="stat-label">Started</div>
            <div class="stat-value">${new Date(session.startTime).toLocaleString()}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Duration</div>
            <div class="stat-value">${duration}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Total Locations</div>
            <div class="stat-value">${locations.length}</div>
          </div>
        </div>

        <div style="margin-top: 20px;">
          <button onclick="toggleMap()" style="width: 100%; max-width: 100%; margin-bottom: 20px;">üó∫Ô∏è View Path on Map</button>
        </div>

        <div class="map-container" id="mapContainer">
          <div id="map"></div>
          <div class="map-info">
            <button class="close-map" onclick="toggleMap()">Close Map</button>
            <div style="clear: both; margin-top: 10px;">
              <strong>Total Path Distance:</strong> <span id="distance">Calculating...</span> km
            </div>
          </div>
        </div>

        <div style="margin-top: 20px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
          <h3>üìç Location History (Last 10)</h3>
          <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
            <thead>
              <tr style="background: #f7f9fc; border-bottom: 2px solid #ddd;">
                <th style="padding: 10px; text-align: left; color: #667eea;">Latitude</th>
                <th style="padding: 10px; text-align: left; color: #667eea;">Longitude</th>
                <th style="padding: 10px; text-align: left; color: #667eea;">Accuracy (m)</th>
                <th style="padding: 10px; text-align: left; color: #667eea;">Time</th>
              </tr>
            </thead>
            <tbody>
              ${locations.slice(-10).reverse().map(loc => `
                <tr style="border-bottom: 1px solid #eee;">
                  <td style="padding: 10px;">${loc.latitude.toFixed(6)}</td>
                  <td style="padding: 10px;">${loc.longitude.toFixed(6)}</td>
                  <td style="padding: 10px;">${Math.round(loc.accuracy)}</td>
                  <td style="padding: 10px;">${new Date(loc.timestamp).toLocaleString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      // Store locations for map
      window.currentLocations = locations;
    }

    function toggleMap() {
      const mapContainer = document.getElementById('mapContainer');
      mapContainer.classList.toggle('active');

      if (mapContainer.classList.contains('active')) {
        setTimeout(() => {
          if (!map) {
            initializeMap();
          } else {
            map.invalidateSize();
          }
          drawPath();
        }, 100);
      }
    }

    function initializeMap() {
      if (map) return;

      map = L.map('map').setView([20, 78], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);
    }

    function drawPath() {
      if (!map || !window.currentLocations) return;

      const locations = window.currentLocations;
      const latlngs = locations.map(loc => [loc.latitude, loc.longitude]);

      // Clear existing layers
      map.eachLayer(layer => {
        if (layer instanceof L.Polyline || layer instanceof L.CircleMarker) {
          map.removeLayer(layer);
        }
      });

      // Draw path
      const polyline = L.polyline(latlngs, {
        color: '#667eea',
        weight: 3,
        opacity: 0.8
      }).addTo(map);

      // Add markers
      if (latlngs.length > 0) {
        // Start marker
        L.circleMarker(latlngs[0], {
          radius: 8,
          fillColor: '#4caf50',
          color: '#2e7d32',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        }).addTo(map).bindPopup('Start Location');

        // End marker
        L.circleMarker(latlngs[latlngs.length - 1], {
          radius: 8,
          fillColor: '#f44336',
          color: '#d32f2f',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        }).addTo(map).bindPopup('End Location');
      }

      // Calculate distance
      let totalDistance = 0;
      for (let i = 1; i < latlngs.length; i++) {
        totalDistance += calculateDistance(
          latlngs[i - 1][0], latlngs[i - 1][1],
          latlngs[i][0], latlngs[i][1]
        );
      }

      document.getElementById('distance').textContent = totalDistance.toFixed(2);

      // Fit bounds
      if (latlngs.length > 0) {
        map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
      }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Load sessions on enter key
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('userIdInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          loadUserSessions();
        }
      });
    });
  </script>
</body>
</html>